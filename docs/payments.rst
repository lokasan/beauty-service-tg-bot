Система платежей
================

Интеграция с Telegram Bot Payments через FreedomPay KG.

Модуль платежей
---------------

.. automodule:: bot.utils.payments
   :members:
   :undoc-members:
   :show-inheritance:

Настройка платежей
------------------

Провайдер: FreedomPay KG
~~~~~~~~~~~~~~~~~~~~~~~~

Бот использует Telegram Bot Payments с провайдером FreedomPay KG для обработки платежей.

Настройка в .env:

.. code-block:: text

   TELEGRAM_PAYMENT_PROVIDER_TOKEN=your_provider_token_from_botfather
   FREEDOMPAY_ACCOUNT=545158
   FREEDOMPAY_IS_TEST=true

Получение токена провайдера:

1. Откройте @BotFather в Telegram
2. Отправьте ``/mybots``
3. Выберите вашего бота
4. Перейдите в раздел "Payments"
5. Выберите "FreedomPay KG"
6. Получите тестовый токен провайдера

Валюта
------

FreedomPay KG работает с валютой **KGS** (киргизский сом).

Сумма передается в тийинах (1 KGS = 100 тийинов).

Процесс оплаты
--------------

1. **Выставление чека**
   - Мастер завершает запись
   - Создается Invoice в базе данных
   - Мастер выбирает метод оплаты

2. **Отправка счета клиенту**
   - Используется ``send_invoice()`` Telegram Bot API
   - Клиент получает счет в Telegram
   - Счет содержит: название, описание, сумму, валюту

3. **Подтверждение платежа (PreCheckoutQuery)**
   - Когда клиент нажимает "Оплатить"
   - Telegram отправляет PreCheckoutQuery
   - Бот проверяет сумму и валюту
   - Бот подтверждает или отклоняет платеж

4. **Успешная оплата (successful_payment)**
   - После успешной оплаты Telegram отправляет successful_payment
   - Бот обновляет статус Invoice
   - Отправляются уведомления клиенту и мастеру

Обработчики платежей
--------------------

create_invoice_callback
~~~~~~~~~~~~~~~~~~~~~~~

Создает чек для завершенной записи.

Параметры:
- ``appointment_id`` - ID завершенной записи

Результат:
- Создается Invoice со статусом PENDING
- Мастеру предлагается выбрать метод оплаты

payment_method_callback
~~~~~~~~~~~~~~~~~~~~~~~

Отправляет счет клиенту через Telegram Bot Payments.

Процесс:
1. Сохраняет invoice_id как payment_id
2. Формирует LabeledPrice с суммой в тийинах
3. Вызывает ``send_invoice()`` с валютой KGS

pre_checkout_query_handler
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Подтверждает платеж перед оплатой.

Проверяет:
- Существование чека
- Статус чека (не оплачен)
- Сумму (допускается погрешность в 1 тийин)
- Валюту (должна быть KGS)

Отвечает:
- ``ok=True`` - если все проверки пройдены
- ``ok=False`` - если есть ошибки

successful_payment_handler
~~~~~~~~~~~~~~~~~~~~~~~~~~

Обрабатывает успешную оплату.

Действия:
1. Обновляет статус Invoice на SUCCEEDED
2. Устанавливает дату оплаты
3. Отправляет уведомление клиенту
4. Отправляет уведомление мастеру

Тестовые данные
---------------

Для тестирования используйте:

* **Тестовая карта**: ``4111 1111 1111 1111``
* **Срок действия**: ``12/24`` или ``12/25``
* **CVV**: ``123``
* **Имя владельца**: ``test``

Важно: Тестовые платежи не списывают реальные средства.

Обработка ошибок
----------------

Все ошибки логируются в ``bot/logs/bot.log``:

* Ошибки отправки счета
* Ошибки подтверждения PreCheckoutQuery
* Ошибки обработки successful_payment

Проверка статуса платежа
------------------------

Статус платежа проверяется автоматически:

* PENDING - чек создан, ожидает оплаты
* SUCCEEDED - платеж успешно завершен
* CANCELLED - платеж отменен


