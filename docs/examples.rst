–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
=====================

–ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã
-----------------------------

–ü—Ä–∏–º–µ—Ä –ø—Ä–æ—Å—Ç–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã:

.. code-block:: python

   from telegram import Update
   from telegram.ext import ContextTypes
   
   async def my_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /mycommand"""
       await update.message.reply_text("–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ –º–æ—è –∫–æ–º–∞–Ω–¥–∞.")

–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ main.py:

.. code-block:: python

   application.add_handler(CommandHandler("mycommand", my_command))

–°–æ–∑–¥–∞–Ω–∏–µ callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
------------------------------

–ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ callback query:

.. code-block:: python

   async def my_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback query"""
       query = update.callback_query
       await query.answer()
       
       # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ callback_data
       data = query.data  # –Ω–∞–ø—Ä–∏–º–µ—Ä, "action_value"
       
       # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
       await query.edit_message_text("–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–µ–π—Å—Ç–≤–∏—è")

–†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
---------------------

–ü—Ä–∏–º–µ—Ä –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î:

.. code-block:: python

   from bot.handlers.common import get_db_from_context
   from bot.models import User
   
   async def get_user(update: Update, context: ContextTypes.DEFAULT_TYPE):
       db = get_db_from_context(context)
       user_data = update.effective_user
       
       # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
       user = db.query(User).filter(
           User.telegram_id == user_data.id
       ).first()
       
       if not user:
           # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
           user = User(
               telegram_id=user_data.id,
               username=user_data.username,
               full_name=user_data.full_name
           )
           db.add(user)
           db.commit()

–°–æ–∑–¥–∞–Ω–∏–µ inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
---------------------------

–ü—Ä–∏–º–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã:

.. code-block:: python

   from telegram import InlineKeyboardButton, InlineKeyboardMarkup
   
   keyboard = [
       [InlineKeyboardButton("–ö–Ω–æ–ø–∫–∞ 1", callback_data="action_1")],
       [InlineKeyboardButton("–ö–Ω–æ–ø–∫–∞ 2", callback_data="action_2")],
       [InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="back")]
   ]
   reply_markup = InlineKeyboardMarkup(keyboard)
   
   await update.message.reply_text(
       "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
       reply_markup=reply_markup
   )

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
----------------------------------------

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è safe_edit_message_text:

.. code-block:: python

   from bot.utils.telegram_helpers import safe_edit_message_text
   
   async def edit_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
       query = update.callback_query
       await query.answer()
       
       await safe_edit_message_text(
           query,
           "–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è",
           reply_markup=new_keyboard
       )

–°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
----------------------

–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ú–∞—Å—Ç–µ—Ä —Å–æ–∑–¥–∞–µ—Ç —É—Å–ª—É–≥—É
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. –ú–∞—Å—Ç–µ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "üìã –ú–æ–∏ —É—Å–ª—É–≥–∏"
2. –í—ã–±–∏—Ä–∞–µ—Ç "‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É"
3. –í–≤–æ–¥–∏—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
4. –í–≤–æ–¥–∏—Ç –æ–ø–∏—Å–∞–Ω–∏–µ
5. –í–≤–æ–¥–∏—Ç —Ü–µ–Ω—É (–≤–∞–ª–∏–¥–∞—Ü–∏—è)
6. –í–≤–æ–¥–∏—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–≤–∞–ª–∏–¥–∞—Ü–∏—è)
7. –£—Å–ª—É–≥–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ

–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ö–ª–∏–µ–Ω—Ç –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ –º–∞—Å—Ç–µ—Ä–∞
2. –í–∏–¥–∏—Ç —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ –º–∞—Å—Ç–µ—Ä–∞
3. –í—ã–±–∏—Ä–∞–µ—Ç —É—Å–ª—É–≥—É
4. –í—ã–±–∏—Ä–∞–µ—Ç –¥–∞—Ç—É –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
5. –í—ã–±–∏—Ä–∞–µ—Ç –≤—Ä–µ–º—è –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤
6. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç (—Ç–µ–ª–µ—Ñ–æ–Ω)
7. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å
8. –ü–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏

–°—Ü–µ–Ω–∞—Ä–∏–π 3: –ú–∞—Å—Ç–µ—Ä –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. –ú–∞—Å—Ç–µ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏"
2. –í—ã–±–∏—Ä–∞–µ—Ç "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ"
3. –í—ã–±–∏—Ä–∞–µ—Ç "üìÖ –û–±—â–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ"
4. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —á–∞—Å—ã —Ä–∞–±–æ—Ç—ã –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏
5. –ò–ª–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –¥–Ω–µ–π
6. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏ –∏–ª–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ

–°—Ü–µ–Ω–∞—Ä–∏–π 4: –û–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥–∏
~~~~~~~~~~~~~~~~~~~~~~~~~~

1. –ú–∞—Å—Ç–µ—Ä –∑–∞–≤–µ—Ä—à–∞–µ—Ç –∑–∞–ø–∏—Å—å
2. –ù–∞–∂–∏–º–∞–µ—Ç "üí≥ –í—ã—Å—Ç–∞–≤–∏—Ç—å —á–µ–∫"
3. –í—ã–±–∏—Ä–∞–µ—Ç –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã
4. –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —Å—á–µ—Ç –≤ Telegram
5. –ö–ª–∏–µ–Ω—Ç –Ω–∞–∂–∏–º–∞–µ—Ç "–û–ø–ª–∞—Ç–∏—Ç—å"
6. –í–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
7. –ë–æ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ (PreCheckoutQuery)
8. –û–ø–ª–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è (successful_payment)
9. –ö–ª–∏–µ–Ω—Ç –∏ –º–∞—Å—Ç–µ—Ä –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
------------------------------

–ü—Ä–∏–º–µ—Ä: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º –º–æ–¥—É–ª–µ handlers
2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ ``bot/main.py``:

.. code-block:: python

   from bot.handlers import my_module
   application.add_handler(CommandHandler("newcommand", my_module.new_command))

–ü—Ä–∏–º–µ—Ä: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

1. –î–æ–±–∞–≤—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –≤ ``bot/utils/validators.py``
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö:

.. code-block:: python

   from bot.utils.validators import my_validator
   
   if not my_validator(value):
       await update.message.reply_text("–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏")
       return

–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏
---------------

* –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ``get_db_from_context()`` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –ë–î
* –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ``safe_edit_message_text()`` –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
* –õ–æ–≥–∏—Ä—É–π—Ç–µ –≤—Å–µ –≤–∞–∂–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
* –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ —Å try/except
* –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ type hints –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –∫–æ–¥–∞
* –°–ª–µ–¥—É–π—Ç–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º SOLID –∏ KISS


