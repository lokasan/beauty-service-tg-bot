Обработчики (Handlers)
======================

Модуль содержит все обработчики команд и callback queries для взаимодействия с пользователями.

Обработчики команд
------------------

.. automodule:: bot.handlers.common
   :members:
   :undoc-members:
   :show-inheritance:

Обработчики для мастеров
------------------------

.. automodule:: bot.handlers.master
   :members:
   :undoc-members:
   :show-inheritance:

Обработчики для клиентов
------------------------

.. automodule:: bot.handlers.client
   :members:
   :undoc-members:
   :show-inheritance:

Обработчики платежей
--------------------

.. automodule:: bot.handlers.invoice
   :members:
   :undoc-members:
   :show-inheritance:

Описание обработчиков
---------------------

common.py
~~~~~~~~~

Общие обработчики для всех пользователей:

* ``start_command()`` - обработчик команды ``/start``
* ``help_command()`` - обработчик команды ``/help``
* ``get_or_create_user()`` - получение или создание пользователя
* ``feedback_callback()`` - обработка обратной связи

master.py
~~~~~~~~~

Обработчики для мастеров:

* **Профиль**: создание и управление профилем мастера
* **Услуги**: создание, редактирование, удаление, скрытие услуг
* **Расписание**: 
  - Настройка еженедельного расписания
  - Календарь для индивидуальных дней
  - Установка выходных дней
* **Записи**: просмотр записей, завершение записей
* **Платежи**: выставление чеков

client.py
~~~~~~~~~

Обработчики для клиентов:

* ``handle_master_link()`` - обработка ссылки мастера
* ``show_master_services()`` - отображение услуг мастера
* ``date_selected_callback()`` - выбор даты записи
* ``time_selected_callback()`` - выбор времени записи
* ``appointment_confirm_callback()`` - подтверждение записи
* ``client_appointments_callback()`` - просмотр записей клиента
* ``cancel_appointment_callback()`` - отмена записи клиентом

invoice.py
~~~~~~~~~~

Обработчики платежей:

* ``create_invoice_callback()`` - создание чека для завершенной записи
* ``payment_method_callback()`` - выбор метода оплаты и отправка счета
* ``pre_checkout_query_handler()`` - подтверждение платежа перед оплатой
* ``successful_payment_handler()`` - обработка успешной оплаты
* ``check_payment_status_callback()`` - проверка статуса платежа

Особенности реализации
----------------------

Все обработчики используют:

* ``get_db_from_context()`` - для получения сессии БД
* ``safe_edit_message_text()`` - для безопасного редактирования сообщений
* Централизованную обработку ошибок
* Логирование всех действий

Отмена записи клиентом
~~~~~~~~~~~~~~~~~~~~~~

Функция ``cancel_appointment_callback()`` позволяет клиентам отменять свои записи с следующими ограничениями:

* **Проверка принадлежности**: Можно отменить только свою запись
* **Проверка статуса**: Нельзя отменить уже отмененные или завершенные записи
* **Проверка времени**: Отмена возможна не менее чем за 2 часа до начала записи
* **Уведомление мастеру**: Мастер автоматически получает уведомление об отмене
* **Освобождение слота**: После отмены слот становится доступным для новой записи

Кнопка "❌ Отменить" отображается в списке записей клиента для каждой доступной записи (статус PENDING или CONFIRMED).


